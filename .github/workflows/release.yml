permissions:
  contents: write

name: Release

on:
  release:
    types: [published]

jobs:
  release:
    runs-on: ubuntu-latest
    name: Release

    steps:
      - name: Get sources
        uses: actions/checkout@v3
        with:
          path: ImHex
          submodules: recursive

      - name: ðŸ“œ Verify version and set version variable
        run: |
          project_version=`cat ImHex/version.txt`
          tag_version="${{github.event.release.tag_name}}"
          tag_version="${tag_version:1}"
          if [ "$project_version" != "$tag_version" ]; then
            echo "::warning::$project_version and $tag_version are not the same ! Refusing to populate release"
            exit 1
          fi

          echo "version=$project_version" >> $GITHUB_ENV

      - name: Create tarball from sources with dependencies
        run: tar -cvf Full.Sources.tar.gz ImHex
        
      - name: Download artifacts from latest workflow
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          workflow: build.yml
          branch: ${{ github.event.release.target_commitish }}
          workflow_conclusion: success
          skip_unpack: true
             
      - name: Unzip files when needed
        run: |	
          for zipfile in ./*.zip
          do
              if [ `zipinfo -1 "$zipfile" | wc -l` -eq 1 ];
              then
                echo "unzipping $zipfile"
                unzip "$zipfile"
                rm "$zipfile"
              else
                echo "keeping $zipfile zipped"
              fi
          done

      - name: Rename Windows Portable Zip
        run: mv "Windows Portable.zip" imhex-${{env.version}}-Windows-Portable.zip

      - name: Upload everything to release
        uses: softprops/action-gh-release@v1
        with:
          files: '*'
