name: Build

on:
  push:
    branches: ["*"]
  pull_request:
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  # RPM distro builds
  rpm-build:
    strategy:
      matrix:
        include:
          - name: Fedora
            mock_release: rawhide
            release_num: rawhide
            mock_config: fedora-rawhide
          - name: Fedora
            mock_release: f37
            release_num: 37
            mock_config: fedora-37
          - name: Fedora
            mock_release: f36
            release_num: 36
            mock_config: fedora-36
          - name: RHEL/AlmaLinux
            mock_release: epel9
            release_num: 9
            mock_config: "alma+epel-9"

    name: üêß ${{ matrix.name }} ${{ matrix.release_num }}
    runs-on: ubuntu-latest
    
    container:
      image: "fedora:latest"
      options: --privileged

    steps:
      - name: ‚¨áÔ∏è Update all packages
        run: |
          dnf upgrade --disablerepo="*" --enablerepo="fedora,updates" -y

      - name: ‚¨áÔ∏è Install setup dependencies
        run: |
          dnf install --disablerepo="*" --enablerepo="fedora,updates" -y \
          fedpkg       \
          which
          
      - name: üß∞ Checkout
        uses: actions/checkout@v3
        with:
          path: ImHex
          submodules: recursive

      - name: üìú Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: rpm-${{ matrix.mock_release }}-${{ secrets.CACHE_VERSION }}-build-${{ github.run_id }}
          restore-keys: rpm-${{ matrix.mock_release }}-${{ secrets.CACHE_VERSION }}-build
          max-size: 1G

      - name: üìú Set version variable
        run: |
          echo "IMHEX_VERSION=`cat ImHex/VERSION`" >> $GITHUB_ENV
      
      - name: üóúÔ∏è Create tarball from sources with dependencies
        run: tar --exclude-vcs -czf $GITHUB_WORKSPACE/imhex-$IMHEX_VERSION.tar.gz ImHex
      
      - name: Add version and release to spec file
        run: sed -i -e 's/%{_version}/${{env.IMHEX_VERSION}}/g' -e 's/%{_build_type}/${{env.BUILD_TYPE}}/g' $GITHUB_WORKSPACE/ImHex/dist/rpm/imhex.spec
        
      - name: Copy spec file to build root
        run: mv $GITHUB_WORKSPACE/ImHex/dist/rpm/imhex.spec $GITHUB_WORKSPACE/imhex.spec

      - name: Enable ccache for mock
        run: |
          cat <<EOT > $GITHUB_WORKSPACE/mock.cfg
          include('${{ matrix.mock_config }}-x86_64.cfg')
          config_opts['plugin_conf']['ccache_enable'] = True
          config_opts['plugin_conf']['ccache_opts']['max_cache_size'] = '1G'
          config_opts['plugin_conf']['ccache_opts']['compress'] = None
          config_opts['plugin_conf']['ccache_opts']['dir'] = "$GITHUB_WORKSPACE/.ccache"
          EOT
      
      # Fedora cmake build (in imhex.spec)
      - name: üì¶ Build RPM
        run: |
          fedpkg --path $GITHUB_WORKSPACE --release ${{ matrix.mock_release }} mockbuild --root $GITHUB_WORKSPACE/mock.cfg extra_args -- -v
#          mv ~/rpmbuild/RPMS/x86_64/*.rpm imhex-${{env.IMHEX_VERSION}}-Fedora-${{matrix.release}}.rpm
          
      - name: ‚¨ÜÔ∏è Upload RPM
        uses: actions/upload-artifact@v3
        with:
          name: Fedora ${{ matrix.release_num }} RPM
          path: |
            imhex-${{env.IMHEX_VERSION}}-Fedora-${{matrix.release_num}}.rpm
