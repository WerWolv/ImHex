name: Build

on:
  push:
    branches:
      - 'master'
      - 'releases/**'
      - 'tests/**'
  pull_request:
  workflow_dispatch:

env:
  BUILD_TYPE: RelWithDebInfo

jobs:

  # Windows build
  win:
    runs-on: windows-2022
    name: ğŸªŸ Windows MINGW64

    defaults:
      run:
        shell: msys2 {0}

    env:
      CCACHE_DIR:      "${{ github.workspace }}/.ccache"

    permissions:
      id-token: write
      attestations: write

    steps:
    - name: ğŸ§° Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ğŸ“œ Setup ccache
      uses:  hendrikmuhs/ccache-action@v1
      id:    cache-ccache
      with:
        key: ${{ runner.os }}-ccache-${{ github.run_id }}
        restore-keys: ${{ runner.os }}-ccache
        max-size: 1G

    - name: ğŸŸ¦ Install msys2
      uses: msys2/setup-msys2@v2
      with:
        msystem: mingw64

    - name: â¬‡ï¸ Install dependencies
      run: |
        set -x
        dist/get_deps_msys2.sh

    - name: â¬‡ï¸ Install .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.100'

    - name: ğŸ“œ Set version variable
      run: |
        echo "IMHEX_VERSION=`cat VERSION`" >> $GITHUB_ENV

    # Windows cmake build
    - name: ğŸ› ï¸ Configure CMake
      run: |
        set -x
        mkdir -p build
        cd build

        cmake -G "Ninja"                                            \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}                  \
          -DCMAKE_INSTALL_PREFIX="$PWD/install"                     \
          -DIMHEX_GENERATE_PACKAGE=ON                               \
          -DIMHEX_USE_DEFAULT_BUILD_SETTINGS=ON                     \
          -DIMHEX_PATTERNS_PULL_MASTER=ON                           \
          -DIMHEX_COMMIT_HASH_LONG="${GITHUB_SHA}"                  \
          -DIMHEX_COMMIT_BRANCH="${GITHUB_REF##*/}"                 \
          -DUSE_SYSTEM_CAPSTONE=ON                                  \
          -DIMHEX_GENERATE_PDBS=ON                                  \
          -DIMHEX_REPLACE_DWARF_WITH_PDB=ON                         \
          -DDOTNET_EXECUTABLE="C:/Program Files/dotnet/dotnet.exe"  \
          ..

    - name: ğŸ› ï¸ Build
      run: |
        cd build
        ninja install
        cpack
        mv ImHex-*.msi ../imhex-${{ env.IMHEX_VERSION }}-Windows-x86_64.msi

        echo "ImHex checks for the existence of this file to determine if it is running in portable mode. You should not delete this file" > $PWD/install/PORTABLE

    - name: ğŸ—ï¸ Generate build provenance attestations
      uses: actions/attest-build-provenance@v2
      with:
        subject-path: |
          imhex-*.msi

    - name: â¬†ï¸ Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        if-no-files-found: error
        name: Windows Installer x86_64
        path: |
          imhex-*.msi

    - name: â¬†ï¸ Upload Portable ZIP
      uses: actions/upload-artifact@v4
      with:
        if-no-files-found: error
        name: Windows Portable x86_64
        path: |
          build/install/*

    - name: â¬‡ï¸ Download Mesa3D for NoGPU version
      shell: bash
      run: |
        set -x
        echo "NoGPU version Powered by Mesa 3D : https://fdossena.com/?p=mesa%2Findex.frag" > build/install/MESA.md
        curl https://downloads.fdossena.com/geth.php?r=mesa64-latest -L -o mesa.7z
        7z e mesa.7z
        mv opengl32.dll build/install

    - name: â¬†ï¸ Upload NoGPU Portable ZIP
      uses: actions/upload-artifact@v4
      with:
        if-no-files-found: error
        name: Windows Portable NoGPU x86_64
        path: |
          build/install/*

  win-plugin-template-test:
    runs-on: windows-2022
    name: ğŸ§ª Plugin Template Test

    defaults:
      run:
        shell: msys2 {0}

    needs: win

    env:
      IMHEX_SDK_PATH: "${{ github.workspace }}/out/sdk"

    steps:
      - name: ğŸ§° Checkout ImHex
        uses: actions/checkout@v4
        with:
          path: imhex

      - name: ğŸŸ¦ Install msys2
        uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64

      - name: â¬‡ï¸ Install dependencies
        run: |
          set -x
          imhex/dist/get_deps_msys2.sh

      - name: ğŸ§° Checkout ImHex-Plugin-Template
        uses: actions/checkout@v4
        with:
          repository: WerWolv/ImHex-Plugin-Template
          submodules: recursive
          path: template

      - name: â¬‡ï¸ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: Windows Portable x86_64
          path: out

      - name: ğŸ› ï¸ Build
        run: |
          set -x
          cd template
          mkdir -p build
          cd build
  
          cmake -G "Ninja"                                          \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}                  \
          -DIMHEX_USE_DEFAULT_BUILD_SETTINGS=ON                     \
          -DUSE_SYSTEM_CAPSTONE=ON                                  \
          ..
          
          ninja

  # MacOS build
  macos:
    runs-on: macos-13

    permissions:
      id-token: write
      attestations: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - suffix: "-NoGPU"
            custom_glfw: true
          - suffix: ""
            custom_glfw: false

    name: ğŸ macOS 13${{ matrix.suffix }}

    steps:
    - name: ğŸ§° Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ğŸ“œ Set version variable
      run: |
        echo "IMHEX_VERSION=`cat VERSION`" >> $GITHUB_ENV

    - name: ğŸ“œ Setup ccache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: ${{ runner.os }}${{ matrix.suffix }}-ccache-${{ github.run_id }}
        restore-keys: ${{ runner.os }}${{ matrix.suffix }}-ccache
        max-size: 1G

    - name: â¬‡ï¸ Install dependencies
      env:
        # Make brew not display useless errors
        HOMEBREW_TESTS: 1
      run: |
        brew reinstall python --quiet || true
        brew link --overwrite --quiet python 2>/dev/null || true
        brew bundle --no-lock --quiet --file dist/Brewfile || true
        rm -rf /usr/local/Cellar/capstone

    - name: â¬‡ï¸ Install classic glfw
      if: ${{! matrix.custom_glfw }}
      run: |
        brew install --quiet glfw || true

    - name: â¬‡ï¸ Install .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.100'

    - name: ğŸ§° Checkout glfw
      if: ${{ matrix.custom_glfw }}
      uses: actions/checkout@v4
      with:
        repository: glfw/glfw
        path: glfw

    # GLFW custom build (to allow software rendering)
    - name: â¬‡ï¸ Patch and install custom glfw
      if: ${{ matrix.custom_glfw }}
      run: |
        set -x
        cd glfw
        git apply ../dist/macOS/0001-glfw-SW.patch

        mkdir build
        cd build

        cmake -G "Ninja"                                \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}      \
          -DBUILD_SHARED_LIBS=ON                        \
          -DCMAKE_C_COMPILER_LAUNCHER=ccache            \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache          \
          -DCMAKE_OBJC_COMPILER_LAUNCHER=ccache         \
          -DCMAKE_OBJCXX_COMPILER_LAUNCHER=ccache       \
        ..
        ninja install

    # MacOS cmake build
    - name: ğŸ› ï¸ Configure CMake
      run: |
        set -x
        mkdir -p build
        cd build
        CC=$(brew --prefix llvm)/bin/clang                                                          \
        CXX=$(brew --prefix llvm)/bin/clang++                                                       \
        OBJC=$(brew --prefix llvm)/bin/clang                                                        \
        OBJCXX=$(brew --prefix llvm)/bin/clang++                                                    \
        PKG_CONFIG_PATH="$(brew --prefix openssl)/lib/pkgconfig":"$(brew --prefix)/lib/pkgconfig"   \
        cmake -G "Ninja"                                                                            \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}                                                  \
          -DIMHEX_GENERATE_PACKAGE=ON                                                               \
          -DIMHEX_SYSTEM_LIBRARY_PATH="$(brew --prefix llvm)/lib;$(brew --prefix llvm)/lib/unwind;$(brew --prefix llvm)/lib/c++;$(brew --prefix)/lib" \
          -DCMAKE_C_COMPILER_LAUNCHER=ccache                                                        \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache                                                      \
          -DCMAKE_OBJC_COMPILER_LAUNCHER=ccache                                                     \
          -DCMAKE_OBJCXX_COMPILER_LAUNCHER=ccache                                                   \
          -DCMAKE_INSTALL_PREFIX="./install"                                                        \
          -DIMHEX_PATTERNS_PULL_MASTER=ON                                                           \
          -DIMHEX_COMMIT_HASH_LONG="${GITHUB_SHA}"                                                  \
          -DIMHEX_COMMIT_BRANCH="${GITHUB_REF##*/}"                                                 \
          ..

    - name: ğŸ› ï¸ Build
      run: cd build && ninja install

    - name: âœ’ï¸ Fix Signature
      run: |
        set -x
        cd build/install
        mv imhex.app ImHex.app
        codesign --remove-signature ImHex.app
        codesign --force --deep --sign - ImHex.app

    - name: ğŸ“ Fix permissions
      run: |
        set -x
        cd build/install
        chmod -R 755 ImHex.app/

    - name: ğŸ”« Kill XProtect
      run: |
        # See https://github.com/actions/runner-images/issues/7522
        echo Killing XProtect...; sudo pkill -9 XProtect >/dev/null || true;
        echo Waiting for XProtect process...; while pgrep XProtect; do sleep 3; done;

    - name: ğŸ“¦ Create DMG
      run: |
        set -x
        mkdir bundle
        mv build/install/ImHex.app bundle
        cd bundle
        ln -s /Applications Applications
        cd ..
        for i in $(seq 1 10); do
            if hdiutil create -volname "ImHex" -srcfolder bundle -ov -format UDZO imhex-${{ env.IMHEX_VERSION }}-macOS${{ matrix.suffix }}-x86_64.dmg; then
                echo "Created dmg after ${i} attempts"
                break
            fi
            sleep 10
        done

    - name: ğŸ—ï¸ Generate build provenance attestations
      uses: actions/attest-build-provenance@v2
      with:
        subject-path: |
          ./*.dmg

    - name: â¬†ï¸ Upload DMG
      uses: actions/upload-artifact@v4
      with:
        if-no-files-found: error
        name: macOS DMG${{ matrix.suffix }} x86_64
        path: ./*.dmg

  macos-arm64-build:
    runs-on: ubuntu-24.04
    name: ğŸ macOS 13 arm64

    outputs:
      IMHEX_VERSION: ${{ steps.build.outputs.IMHEX_VERSION }}

    steps:
    - name: ğŸ§° Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ğŸ“ Restore docker /cache
      uses: actions/cache@v4
      with:
        path: cache
        key: build-macos-arm64-cache

    - name: ğŸ³ Inject /cache into docker
      uses: reproducible-containers/buildkit-cache-dance@v2
      with:
        cache-source: cache
        cache-target: /cache

    - name: ğŸ› ï¸ Build using docker
      id: build
      run: |
        echo "IMHEX_VERSION=`cat VERSION`" >> $GITHUB_OUTPUT
        docker buildx build . -f dist/macOS/arm64.Dockerfile --progress=plain --build-arg 'JOBS=4' --build-arg "BUILD_TYPE=$(BUILD_TYPE)" --build-context imhex=$(pwd) --output out

    - name: â¬†ï¸ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos_arm64_intermediate
        path: out/

      # See https://github.com/actions/cache/issues/342#issuecomment-1711054115
    - name: ğŸ—‘ï¸ Delete old cache
      continue-on-error: true
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
          gh extension install actions/gh-actions-cache
          gh actions-cache delete "build-macos-arm64-cache" --confirm || true

  macos-arm64-package:
    runs-on: macos-13
    name: ğŸ macOS 13 arm64 Packaging
    needs: macos-arm64-build

    env:
      IMHEX_VERSION: ${{ needs.macos-arm64-build.outputs.IMHEX_VERSION }}

    permissions:
      id-token: write
      attestations: write

    steps:
      - name: â¬‡ï¸ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: macos_arm64_intermediate
          path: out

      - name: ğŸ—‘ï¸ Delete artifact
        uses: geekyeggo/delete-artifact@v5
        with:
          name: macos_arm64_intermediate

      - name: âœ’ï¸ Fix Signature
        run: |
          set -x
          cd out
          mv imhex.app ImHex.app
          codesign --remove-signature ImHex.app
          codesign --force --deep --sign - ImHex.app

      - name: ğŸ“ Fix permissions
        run: |
          set -x
          cd out
          chmod -R 755 ImHex.app/

      - name: ğŸ”« Kill XProtect
        run: |
          # See https://github.com/actions/runner-images/issues/7522
          echo Killing XProtect...; sudo pkill -9 XProtect >/dev/null || true;
          echo Waiting for XProtect process...; while pgrep XProtect; do sleep 3; done;

      - name: ğŸ“¦ Create DMG
        run: |
          set -x
          mkdir bundle
          mv out/ImHex.app bundle
          cd bundle
          ln -s /Applications Applications
          cd ..
          for i in $(seq 1 10); do
              if hdiutil create -volname "ImHex" -srcfolder bundle -ov -format UDZO imhex-${{ env.IMHEX_VERSION }}-macOS-arm64.dmg; then
                  echo "Created dmg after ${i} attempts"
                  break
              fi
              sleep 10
          done

      - name: ğŸ—ï¸ Generate build provenance attestations
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: |
            ./*.dmg

      - name: â¬†ï¸ Upload DMG
        uses: actions/upload-artifact@v4
        with:
          if-no-files-found: error
          name: macOS DMG arm64
          path: ./*.dmg

  # Ubuntu build
  ubuntu:
    strategy:
      fail-fast: false
      matrix:
        include:
          - release_num: "24.04"
          - release_num: "24.10"

    name: ğŸ§ Ubuntu ${{ matrix.release_num }}
    runs-on: ubuntu-24.04

    container:
      image: "ubuntu:${{ matrix.release_num }}"
      options: --privileged

    permissions:
      id-token: write
      attestations: write

    steps:
      - name: â¬‡ï¸ Install setup dependencies
        run: apt update && apt install -y git curl

      - name: ğŸ§° Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ğŸ“œ Setup ccache
        uses: hendrikmuhs/ccache-action@v1
        with:
          key: Ubuntu-${{ matrix.release_num }}-ccache-${{ github.run_id }}
          restore-keys: Ubuntu-${{ matrix.release_num }}-ccache
          max-size: 1G

      - name: â¬‡ï¸ Install dependencies
        run: |
          apt update
          bash dist/get_deps_debian.sh

      - name: â¬‡ï¸ Install .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.100'

      # Ubuntu cmake build
      - name: ğŸ› ï¸ Configure CMake
        shell: bash
        run: |
          set -x
          git config --global --add safe.directory '*'
          mkdir -p build
          cd build
          CC=gcc-14 CXX=g++-14 cmake -G "Ninja"                       \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}                  \
            -DCMAKE_INSTALL_PREFIX="/usr"                             \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache                        \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache                      \
            -DIMHEX_PATTERNS_PULL_MASTER=ON                           \
            -DIMHEX_COMMIT_HASH_LONG="${GITHUB_SHA}"                  \
            -DIMHEX_COMMIT_BRANCH="${GITHUB_REF##*/}"                 \
            -DIMHEX_ENABLE_LTO=ON                                     \
            -DIMHEX_USE_GTK_FILE_PICKER=ON                            \
            -DDOTNET_EXECUTABLE="dotnet"                              \
            ..

      - name: ğŸ› ï¸ Build
        run: cd build && DESTDIR=DebDir ninja install

      - name: ğŸ“œ Set version variable
        run: |
          echo "IMHEX_VERSION=`cat VERSION`" >> $GITHUB_ENV

      - name: ğŸ“¦ Bundle DEB
        run: |
          cp -r build/DEBIAN build/DebDir
          dpkg-deb -Zzstd --build build/DebDir
          mv build/DebDir.deb imhex-${{ env.IMHEX_VERSION }}-Ubuntu-${{ matrix.release_num }}-x86_64.deb

      - name: ğŸ—ï¸ Generate build provenance attestations
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: |
            ./*.deb

      - name: â¬†ï¸ Upload DEB
        uses: actions/upload-artifact@v4
        with:
          if-no-files-found: error
          name: Ubuntu ${{ matrix.release_num }} DEB x86_64
          path: '*.deb'

  # AppImage build
  appimage:
    runs-on: ubuntu-24.04
    name: â¬‡ï¸ AppImage

    permissions:
      id-token: write
      attestations: write

    steps:
      - name: ğŸ§° Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ğŸ“ Restore docker /cache
        uses: actions/cache@v4
        with:
          path: cache
          key: appimage-ccache-${{ github.run_id }}
          restore-keys: appimage-cache

      - name: ğŸ³ Inject /cache into docker
        uses: reproducible-containers/buildkit-cache-dance@v2
        with:
          cache-source: cache
          cache-target: /cache

      - name: ğŸ› ï¸ Build using docker
        run: |
          docker buildx build . -f dist/appimage/Dockerfile --progress=plain --build-arg "BUILD_TYPE=$BUILD_TYPE" \
          --build-arg "GIT_COMMIT_HASH=$GITHUB_SHA" --build-arg "GIT_BRANCH=${GITHUB_REF##*/}" --output out

      - name: ğŸ—ï¸ Generate build provenance attestations
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: |
            out/*.AppImage
            out/*.AppImage.zsync

      - name: â¬†ï¸ Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          if-no-files-found: error
          name: Linux AppImage x86_64
          path: 'out/*.AppImage'

      - name: â¬†ï¸ Upload AppImage zsync
        uses: actions/upload-artifact@v4
        with:
          if-no-files-found: error
          name: Linux AppImage zsync x86_64
          path: 'out/*.AppImage.zsync'

  # ArchLinux build
  archlinux-build:
    name: ğŸ§ ArchLinux
    runs-on: ubuntu-24.04

    container:
      image: archlinux:base-devel

    permissions:
      id-token: write
      attestations: write

    steps:
      - name: â¬‡ï¸ Update all packages
        run: |
          pacman -Syyu --noconfirm

      - name: â¬‡ï¸ Install setup dependencies
        run: |
          pacman -Syu git ccache --noconfirm

      - name: ğŸ§° Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: â¬‡ï¸ Install ImHex dependencies
        run: |
          dist/get_deps_archlinux.sh --noconfirm

      - name: â¬‡ï¸ Install .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.100'

      - name: ğŸ“œ Setup ccache
        uses: hendrikmuhs/ccache-action@v1
        with:
          key: archlinux-ccache-${{ github.run_id }}
          restore-keys: archlinux-ccache
          max-size: 1G

      # ArchLinux cmake build
      - name: ğŸ› ï¸ Configure CMake
        run: |
          set -x
          mkdir -p build
          cd build
          CC=gcc CXX=g++ cmake -G "Ninja"               \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}      \
          -DCMAKE_INSTALL_PREFIX="/usr"                 \
          -DCMAKE_C_COMPILER_LAUNCHER=ccache            \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache          \
          -DUSE_SYSTEM_FMT=ON                           \
          -DUSE_SYSTEM_YARA=ON                          \
          -DUSE_SYSTEM_NLOHMANN_JSON=ON                 \
          -DUSE_SYSTEM_CAPSTONE=OFF                     \
          -DIMHEX_PATTERNS_PULL_MASTER=ON               \
          -DIMHEX_COMMIT_HASH_LONG="${GITHUB_SHA}"      \
          -DIMHEX_COMMIT_BRANCH="${GITHUB_REF##*/}"     \
          -DIMHEX_ENABLE_LTO=ON                         \
          -DIMHEX_USE_GTK_FILE_PICKER=ON                \
          ..

      - name: ğŸ› ï¸ Build
        run: cd build && DESTDIR=installDir ninja install

      - name: ğŸ“œ Set version variable
        run: |
          echo "IMHEX_VERSION=`cat VERSION`" >> $GITHUB_ENV

      - name: âœ’ï¸ Prepare PKGBUILD
        run: |
          cp dist/Arch/PKGBUILD build
          sed -i 's/%version%/${{ env.IMHEX_VERSION }}/g' build/PKGBUILD

    # makepkg doesn't want to run as root, so I had to chmod 777 all over
      - name: ğŸ“¦ Package ArchLinux .pkg.tar.zst
        run: |
          set -x
          cd build

          # the name is a small trick to make makepkg recognize it as the source
          # else, it would try to download the file from the release
          tar -cvf imhex-${{ env.IMHEX_VERSION }}-ArchLinux-x86_64.pkg.tar.zst -C installDir .

          chmod -R 777 .

          sudo -u nobody makepkg

          # Replace the old file
          rm imhex-${{ env.IMHEX_VERSION }}-ArchLinux-x86_64.pkg.tar.zst
          rm *imhex-bin-debug* # rm debug package which is created for some reason
          mv *.pkg.tar.zst imhex-${{ env.IMHEX_VERSION }}-ArchLinux-x86_64.pkg.tar.zst

      - name: ğŸ—ï¸ Generate build provenance attestations
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: |
            build/imhex-${{ env.IMHEX_VERSION }}-ArchLinux-x86_64.pkg.tar.zst

      - name: â¬†ï¸ Upload imhex-archlinux.pkg.tar.zst
        uses: actions/upload-artifact@v4
        with:
          if-no-files-found: error
          name: ArchLinux .pkg.tar.zst x86_64
          path: |
            build/imhex-${{ env.IMHEX_VERSION }}-ArchLinux-x86_64.pkg.tar.zst

  # RPM distro builds
  rpm-build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Fedora
            mock_release: rawhide
            release_num: rawhide
            mock_config: fedora-rawhide
          - name: Fedora
            mock_release: f41
            release_num: 41
            mock_config: fedora-41
          - name: Fedora
            mock_release: f40
            release_num: 40
            mock_config: fedora-40
          - name: RHEL-AlmaLinux
            mock_release: epel9
            release_num: 9
            mock_config: "alma+epel-9"

    name: ğŸ§ ${{ matrix.name }} ${{ matrix.release_num }}
    runs-on: ubuntu-24.04

    container:
      image: "almalinux:9"
      options: --privileged --pid=host --security-opt apparmor=unconfined

    permissions:
      id-token: write
      attestations: write

    steps:
      # This, together with the `--pid=host --security-opt apparmor=unconfined` docker options is required to allow
      # fedpkg to work inside a Docker container running on Ubuntu again.
      # GitHub seems to have enabled AppArmor on their Ubuntu CI runners which limits Docker in ways that cause
      # programs inside it to fail.
      # Without this, fedpkg will throw the unhelpful error message 'Insufficient Rights'
      # This step uses nsenter to execute commands on the host that disable AppArmor entirely.
      - name: ğŸ›¡ï¸ Disable AppArmor on Host
        run: |
          nsenter -t 1 -m -u -n -i sudo systemctl disable --now apparmor.service
          nsenter -t 1 -m -u -n -i sudo aa-teardown || true
          nsenter -t 1 -m -u -n -i sudo sysctl --write kernel.apparmor_restrict_unprivileged_unconfined=0
          nsenter -t 1 -m -u -n -i sudo sysctl --write kernel.apparmor_restrict_unprivileged_userns=0

      - name: â¬‡ï¸ Install git-core and EPEL repo
        run: dnf install git-core epel-release -y

      - name: ğŸ§° Checkout
        uses: actions/checkout@v4
        with:
          path: ImHex
          submodules: recursive

      - name: ğŸ“œ Setup DNF Cache
        uses: actions/cache@v4
        with:
          path: /var/cache/dnf
          key: ${{ matrix.mock_release }}-dnf-${{ github.run_id }}
          restore-keys: |
            ${{ matrix.mock_release }}-dnf-

      - name: â¬‡ï¸ Update all packages and install dependencies
        run: |
          set -x
          dnf upgrade -y
          dnf install -y \
          fedpkg         \
          ccache

      - name: â¬‡ï¸ Install .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.100'

      - name: ğŸ“œ Setup ccache
        uses: hendrikmuhs/ccache-action@v1
        with:
          key: ${{ matrix.mock_release }}-rpm-${{ github.run_id }}
          restore-keys: ${{ matrix.mock_release }}-rpm
          max-size: 1G

      - name: ğŸ“œ Set version variable
        run: |
          echo "IMHEX_VERSION=`cat ImHex/VERSION`" >> $GITHUB_ENV

      - name: ğŸ—œï¸ Create tarball from sources with dependencies
        run: tar --exclude-vcs -czf $GITHUB_WORKSPACE/imhex-$IMHEX_VERSION.tar.gz ImHex

      - name: âœ’ï¸ Modify spec file
        run: |
          sed -i \
          -e 's/Version:        VERSION$/Version:        ${{ env.IMHEX_VERSION }}/g'  \
          -e 's/IMHEX_OFFLINE_BUILD=ON/IMHEX_OFFLINE_BUILD=OFF/g'                     \
          -e '/IMHEX_OFFLINE_BUILD=OFF/a -D IMHEX_PATTERNS_PULL_MASTER=ON \\'         \
          -e '/BuildRequires:  cmake/a BuildRequires:  git-core'                      \
          -e '/%files/a %{_datadir}/%{name}/'                                         \
          $GITHUB_WORKSPACE/ImHex/dist/rpm/imhex.spec

      - name: ğŸ“œ Fix ccache on EL9
        if: matrix.mock_release == 'epel9'
        run: sed -i '/\. \/opt\/rh\/gcc-toolset-14\/enable/a PATH=/usr/lib64/ccache:$PATH' $GITHUB_WORKSPACE/ImHex/dist/rpm/imhex.spec

      - name: ğŸŸ© Copy spec file to build root
        run: mv $GITHUB_WORKSPACE/ImHex/dist/rpm/imhex.spec $GITHUB_WORKSPACE/imhex.spec

      - name: ğŸ“œ Enable ccache for mock
        run: |
          cat <<EOT > $GITHUB_WORKSPACE/mock.cfg
          include('${{ matrix.mock_config }}-x86_64.cfg')
          config_opts['plugin_conf']['ccache_enable'] = True
          config_opts['plugin_conf']['ccache_opts']['max_cache_size'] = '1G'
          config_opts['plugin_conf']['ccache_opts']['compress'] = True
          config_opts['plugin_conf']['ccache_opts']['dir'] = "$GITHUB_WORKSPACE/.ccache"
          EOT

      # Fedora cmake build (in imhex.spec)
      - name: ğŸ“¦ Build RPM
        run: |
          fedpkg --path $GITHUB_WORKSPACE --release ${{ matrix.mock_release }} mockbuild --enable-network -N --root $GITHUB_WORKSPACE/mock.cfg extra_args -- -v

      - name: ğŸŸ© Move and rename finished RPM
        run: |
          mv $GITHUB_WORKSPACE/results_imhex/${{ env.IMHEX_VERSION }}/*/imhex-${{ env.IMHEX_VERSION }}-0.*.x86_64.rpm \
          $GITHUB_WORKSPACE/imhex-${{ env.IMHEX_VERSION }}-${{ matrix.name }}-${{ matrix.release_num }}-x86_64.rpm

      - name: ğŸ—ï¸ Generate build provenance attestations
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: |
            imhex-${{ env.IMHEX_VERSION }}-${{ matrix.name }}-${{ matrix.release_num }}-x86_64.rpm

      - name: â¬†ï¸ Upload RPM
        uses: actions/upload-artifact@v4
        with:
          if-no-files-found: error
          name: ${{ matrix.name }} ${{ matrix.release_num }} RPM x86_64
          path: |
            imhex-${{ env.IMHEX_VERSION }}-${{ matrix.name }}-${{ matrix.release_num }}-x86_64.rpm

  webassembly-build:
    runs-on: ubuntu-24.04
    name: ğŸŒ Web
    permissions:
      pages: write
      id-token: write
      actions: write
    steps:
      - name: ğŸ§° Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ğŸ“ Restore docker /cache
        uses: actions/cache@v4
        with:
          path: cache
          key: web-cache-${{ hashFiles('**/CMakeLists.txt') }}

      - name: ğŸ³ Inject /cache into docker
        uses: reproducible-containers/buildkit-cache-dance@v2
        with:
          cache-source: cache
          cache-target: /cache

      - name: ğŸ› ï¸ Build using docker
        run: |
          docker buildx build . -f dist/web/Dockerfile --progress=plain --build-arg 'JOBS=4' --output out --target raw

      - name: ğŸ”¨ Fix permissions
        run: |
          chmod -c -R +rX "out/"

      - name: â¬†ï¸ Upload artifacts
        uses: actions/upload-pages-artifact@v3
        with:
          path: out/

      - name: ğŸ”¨ Copy necessary files
        run: |
          cp dist/web/serve.py out/start_imhex_web.py

      - name: â¬†ï¸ Upload package
        uses: actions/upload-artifact@v4
        with:
          if-no-files-found: error
          name: ImHex Web
          path: out/*

        # See https://github.com/actions/cache/issues/342#issuecomment-1711054115
      - name: ğŸ—‘ï¸ Delete old cache
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh extension install actions/gh-actions-cache || true
          gh actions-cache delete "build-web-cache" --confirm || true

  webassembly-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      pages: write
      id-token: write
      actions: write
    name: ğŸ“ƒ Deploy to GitHub Pages
    runs-on: ubuntu-24.04

    if: ${{ github.ref == 'refs/heads/master' && github.event.repository.fork == false }}
    needs: webassembly-build

    steps:
      - name: ğŸŒ Deploy WebAssembly Build to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ—‘ï¸ Delete artifact
        uses: geekyeggo/delete-artifact@v5
        with:
          name: github-pages
