name: Build

on:
  push:
    branches: ["*"]
  pull_request:
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  # RPM distro builds
  rpm-build:
    strategy:
      matrix:
        include:
#           - name: Fedora
#             mock_release: rawhide
#             release_num: rawhide
#             mock_config: fedora-rawhide
          - name: Fedora
            mock_release: f37
            release_num: 37
            mock_config: fedora-37
          - name: Fedora
            mock_release: f36
            release_num: 36
            mock_config: fedora-36
          - name: RHEL, AlmaLinux
            mock_release: epel9
            release_num: 9
            mock_config: "alma+epel-9"

    name: üêß ${{ matrix.name }} ${{ matrix.release_num }}
    runs-on: ubuntu-latest
    
    container:
      image: "almalinux:9"
      options: --privileged

    steps:
      - name: Install git-core
        #run: dnf install --disablerepo="*" --enablerepo="fedora" git-core -y
        run: dnf install git-core epel-release -y
    
      - name: üß∞ Checkout
        uses: actions/checkout@v3
        with:
          path: ImHex
          submodules: recursive
      
      - name: Setup DNF Cache
        uses: actions/cache@v3
        with:
          path: /var/cache/dnf
          key: ${{ matrix.mock_release }}-dnf-${{ github.run_id }}
          restore-keys: |
            ${{ matrix.mock_release }}-dnf-
    
      - name: ‚¨áÔ∏è Update all packages and install dependencies
        run: |
          dnf upgrade -y
          dnf install -y \
          fedpkg         \
          ccache

      - name: üìú Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2.5
        with:
          key: rpm-${{ matrix.mock_release }}-${{ secrets.CACHE_VERSION }}-build-${{ github.run_id }}
          restore-keys: rpm-${{ matrix.mock_release }}-${{ secrets.CACHE_VERSION }}-build
          max-size: 1G

      - name: üìú Set version variable
        run: |
          echo "IMHEX_VERSION=`cat ImHex/VERSION`" >> $GITHUB_ENV
      
      - name: üóúÔ∏è Create tarball from sources with dependencies
        run: tar --exclude-vcs -czf $GITHUB_WORKSPACE/imhex-$IMHEX_VERSION.tar.gz ImHex
      
      - name: Add version and release to spec file
        run: sed -i -e 's/%{_version}/${{env.IMHEX_VERSION}}/g' -e 's/%{_build_type}/${{env.BUILD_TYPE}}/g' $GITHUB_WORKSPACE/ImHex/dist/rpm/imhex.spec
        
      - name: Fix ccache on EL9
        if: matrix.mock_release == 'epel9'
        run: sed -i '/\. \/opt\/rh\/gcc-toolset-12\/enable/a PATH=/usr/lib64/ccache:$PATH' $GITHUB_WORKSPACE/ImHex/dist/rpm/imhex.spec
        
      - name: Copy spec file to build root
        run: mv $GITHUB_WORKSPACE/ImHex/dist/rpm/imhex.spec $GITHUB_WORKSPACE/imhex.spec

      - name: Enable ccache for mock
        run: |
          cat <<EOT > $GITHUB_WORKSPACE/mock.cfg
          include('${{ matrix.mock_config }}-x86_64.cfg')
          config_opts['plugin_conf']['ccache_enable'] = True
          config_opts['plugin_conf']['ccache_opts']['max_cache_size'] = '1G'
          config_opts['plugin_conf']['ccache_opts']['compress'] = True
          config_opts['plugin_conf']['ccache_opts']['dir'] = "$GITHUB_WORKSPACE/.ccache"
          EOT

      - name: Setup Mock Cache
        uses: actions/cache@v3
        with:
          path: /var/cache/mock
          key: ${{ matrix.mock_release }}-mock-${{ github.run_id }}
          restore-keys: |
            ${{ matrix.mock_release }}-mock-

      # Fedora cmake build (in imhex.spec)
      - name: üì¶ Build RPM
        run: |
          fedpkg --path $GITHUB_WORKSPACE --release ${{ matrix.mock_release }} mockbuild -N --root $GITHUB_WORKSPACE/mock.cfg extra_args -- -v
          # set fortify_source back to 2 - level 3 in rawhide breaks through GH actions for some reason

      - name: ‚¨ÜÔ∏è Upload RPM
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.name }} ${{ matrix.release_num }} RPM
          path: |
            results_imhex/${{env.IMHEX_VERSION}}/*/imhex-${{env.IMHEX_VERSION}}-0.*.x86_64.rpm
