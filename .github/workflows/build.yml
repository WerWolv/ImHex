name: Build

on:
  push:
    branches: ["*"]
  pull_request:
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  # Fedora build     
  fedora-build:
    strategy:
      matrix:
        include:
          - docker_image: fedora:latest
            release: 37

    name: üêß Fedora ${{ matrix.release }}
    runs-on: ubuntu-latest
    
    container:
      image: "${{ matrix.docker_image }}"
      options: --privileged

    steps:
      - name: ‚¨áÔ∏è Update all packages
        run: |
          dnf upgrade --disablerepo="*" --enablerepo="fedora,updates" -y

      - name: ‚¨áÔ∏è Install setup dependencies
        run: |
          dnf install --disablerepo="*" --enablerepo="fedora,updates" -y \
          ccache              \
          fedpkg
          
      - name: üß∞ Checkout
        uses: actions/checkout@v3
        with:
          path: ImHex
          submodules: recursive

      - name: üìú Set version variable
        run: |
          echo "IMHEX_VERSION=`cat ImHex/VERSION`" >> $GITHUB_ENV
      
      - name: üóúÔ∏è Create tarball from sources with dependencies
        run: tar --exclude-vcs -czf $GITHUB_WORKSPACE/imhex-$IMHEX_VERSION.tar.gz $GITHUB_WORKSPACE/ImHex
      
      - name: Add version and release to spec file
        run: sed -i -e 's/%{_version}/${{env.IMHEX_VERSION}}/g' -e 's/%{_build_type}/${{env.BUILD_TYPE}}/g' $GITHUB_WORKSPACE/ImHex/dist/rpm/imhex.spec
      
      - name: Build SRPM
        run: |
          rpmbuild --define "_sourcedir $GITHUB_WORKSPACE" \
          --define "_specdir $GITHUB_WORKSPACE" \
          --define "_builddir $GITHUB_WORKSPACE" \
          --define "_srcrpmdir $GITHUB_WORKSPACE" \
          --define "_rpmdir $GITHUB_WORKSPACE" \
          --define "_rpmfilename %%{NAME}-%%{VERSION}-%%{RELEASE}.%%{ARCH}.rpm" \
          --define "dist %{?distprefix}.fc${{ matrix.release }}" \
          --define "fedora ${{ matrix.release }}" \
          --eval "%undefine rhel" \
          --define "fc${{ matrix.release }} 1" \
          --nodeps -bs $GITHUB_WORKSPACE/ImHex/dist/rpm/imhex.spec
      
      - name: Build RPM
        run: |
          mock -N -v --isolation=simple -r fedora-rawhide-x86_64 --resultdir $GITHUB_WORKSPACE/results \
          --rebuild imhex-${{env.IMHEX_VERSION}}-*.fc*.src.rpm
      
#       # Fedora cmake build (in imhex.spec)
#       - name: üì¶ Build RPM
#         run: |
#           fedpkg --path $GITHUB_WORKSPACE --release ${{ matrix.release }} mockbuild
#           mv ~/rpmbuild/RPMS/x86_64/*.rpm imhex-${{env.IMHEX_VERSION}}-Fedora-${{matrix.release}}.rpm
          
      - name: ‚¨ÜÔ∏è Upload RPM
        uses: actions/upload-artifact@v3
        with:
          name: Fedora ${{ matrix.release }} RPM
          path: |
            imhex-${{env.IMHEX_VERSION}}-Fedora-${{matrix.release}}.rpm
