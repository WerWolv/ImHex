name: Build

on:
  push:
    branches: ["*"]
  pull_request:
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  # Fedora build     
  fedora-build:
    strategy:
      matrix:
        include:
          - docker_image: fedora:latest
            mock_release: f37
            release_num: 37

    name: üêß Fedora ${{ matrix.release_num }}
    runs-on: ubuntu-latest
    
    container:
      image: "${{ matrix.docker_image }}"
      options: --privileged

    steps:
      - name: ‚¨áÔ∏è Update all packages
        run: |
          dnf upgrade --disablerepo="*" --enablerepo="fedora,updates" -y

      - name: ‚¨áÔ∏è Install setup dependencies
        run: |
          dnf install --disablerepo="*" --enablerepo="fedora,updates" -y \
          ccache              \
          fedpkg
          
      - name: üß∞ Checkout
        uses: actions/checkout@v3
        with:
          path: ImHex
          submodules: recursive

      - name: üìú Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: fedora-${{ matrix.mock_release }}-${{ secrets.CACHE_VERSION }}-build-${{ github.run_id }}
          restore-keys: fedora-${{ matrix.mock_release }}-${{ secrets.CACHE_VERSION }}-build
          max-size: 1G

      - name: üìú Set version variable
        run: |
          echo "IMHEX_VERSION=`cat ImHex/VERSION`" >> $GITHUB_ENV
      
      - name: üóúÔ∏è Create tarball from sources with dependencies
        run: tar --exclude-vcs -czf $GITHUB_WORKSPACE/imhex-$IMHEX_VERSION.tar.gz ImHex
        
      - name: list tar contents
        run: |
          tar -tvf $GITHUB_WORKSPACE/imhex-$IMHEX_VERSION.tar.gz
      
      - name: Add version and release to spec file
        run: sed -i -e 's/%{_version}/${{env.IMHEX_VERSION}}/g' -e 's/%{_build_type}/${{env.BUILD_TYPE}}/g' $GITHUB_WORKSPACE/ImHex/dist/rpm/imhex.spec
        
      - name: Copy spec file to build root
        run: mv $GITHUB_WORKSPACE/ImHex/dist/rpm/imhex.spec $GITHUB_WORKSPACE/imhex.spec
      
#       - name: Build SRPM
#         run: |
#           rpmbuild --define "_sourcedir $GITHUB_WORKSPACE" \
#           --define "_specdir $GITHUB_WORKSPACE" \
#           --define "_builddir $GITHUB_WORKSPACE" \
#           --define "_srcrpmdir $GITHUB_WORKSPACE" \
#           --define "_rpmdir $GITHUB_WORKSPACE" \
#           --define "_rpmfilename %%{NAME}-%%{VERSION}-%%{RELEASE}.%%{ARCH}.rpm" \
#           --define "dist %{?distprefix}.fc${{ matrix.release }}" \
#           --define "fedora ${{ matrix.release }}" \
#           --eval "%undefine rhel" \
#           --define "fc${{ matrix.release }} 1" \
#           --nodeps -bs $GITHUB_WORKSPACE/ImHex/dist/rpm/imhex.spec
      
#       - name: Build RPM
#         run: |
#           mock -N -v --isolation=simple -r fedora-rawhide-x86_64 --resultdir $GITHUB_WORKSPACE/results \
#           --rebuild imhex-${{env.IMHEX_VERSION}}-*.fc*.src.rpm

      - name: Enable ccache for mock
        run: |
          cat <<EOT > $GITHUB_WORKSPACE/mock.cfg
          include('fedora-${{ matrix.release_num }}-x86_64.cfg')
          config_opts['plugin_conf']['ccache_enable'] = True
          config_opts['plugin_conf']['ccache_opts']['max_cache_size'] = '1G'
          config_opts['plugin_conf']['ccache_opts']['compress'] = None
          config_opts['plugin_conf']['ccache_opts']['dir'] = "$GITHUB_WORKSPACE/.ccache"
          EOT
      
      # Fedora cmake build (in imhex.spec)
      - name: üì¶ Build RPM
        run: |
          fedpkg --path $GITHUB_WORKSPACE --release ${{ matrix.mock_release }} mockbuild --root $GITHUB_WORKSPACE/mock.cfg extra_args -- -v
#          mv ~/rpmbuild/RPMS/x86_64/*.rpm imhex-${{env.IMHEX_VERSION}}-Fedora-${{matrix.release}}.rpm
          
      - name: ‚¨ÜÔ∏è Upload RPM
        uses: actions/upload-artifact@v3
        with:
          name: Fedora ${{ matrix.release_num }} RPM
          path: |
            imhex-${{env.IMHEX_VERSION}}-Fedora-${{matrix.release_num}}.rpm
