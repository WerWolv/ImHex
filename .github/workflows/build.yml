name: Build

on:
  push:
    branches: ["*"]
  pull_request:
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  # Fedora build     
  fedora-build:
    strategy:
      matrix:
        include:
          - docker_image: fedora:latest
            release: rawhide

    name: üêß Fedora ${{ matrix.release }}
    runs-on: ubuntu-latest
    
    container:
      image: "${{ matrix.docker_image }}"
      options: --privileged

    steps:
      - name: ‚¨áÔ∏è Update all packages
        run: |
          dnf upgrade -y

      - name: ‚¨áÔ∏è Install setup dependencies
        run: |
          dnf install -y     \
          ccache             \
          fedpkg
          
      - name: üß∞ Checkout
        uses: actions/checkout@v3
        with:
          path: ImHex
          submodules: recursive

      - name: üìú Set version variable
        run: |
          echo "IMHEX_VERSION=`cat ImHex/VERSION`" >> $GITHUB_ENV
      
      - name: üóúÔ∏è Create tarball from sources with dependencies
        run: tar --exclude-vcs -czf $GITHUB_WORKSPACE/imhex-$IMHEX_VERSION.tar.gz $GITHUB_WORKSPACE/ImHex
      
      # Fedora cmake build (in imhex.spec)
      - name: üì¶ Build RPM
        run: |
          mv $GITHUB_WORKSPACE/ImHex/dist/rpm/imhex.spec $GITHUB_WORKSPACE/imhex.spec
          sed -i -e 's/%{_version}/${{env.IMHEX_VERSION}}/g' -e 's/%{_build_type}/${{env.BUILD_TYPE}}/g' $GITHUB_WORKSPACE/imhex.spec
          fedpkg -v --path $GITHUB_WORKSPACE --release ${{ matrix.release }} mockbuild 2>&1
          mv ~/rpmbuild/RPMS/x86_64/*.rpm imhex-${{env.IMHEX_VERSION}}-Fedora-${{matrix.release}}.rpm
          
      - name: ‚¨ÜÔ∏è Upload RPM
        uses: actions/upload-artifact@v3
        with:
          name: Fedora ${{ matrix.release }} RPM
          path: |
            imhex-${{env.IMHEX_VERSION}}-Fedora-${{matrix.release}}.rpm
